rules:
  - id: signer-leak
    languages: [move_on_aptos]
    message: Public functions returning signer.
    severity: INFO
    patterns:
      - pattern-not: |
          #[test_only]
          fun $FUN(...): ...
      - pattern-not: |
          #[test]
          fun $FUN(...): ...
      - pattern-not: |
          #[test(...)]
          fun $FUN(...): ...
      
      # Aptos libraries are exempted
      - pattern-not-inside: |
            module aptos_token_objects::$ANY { ... }
      - pattern-not-inside: |
            module aptos_framework::$ANY { ... }

      - pattern-either: 
        - pattern: |
            public fun $FUN(...): signer
        - pattern: |
            public fun $FUN(...): &signer
        - pattern: |
            public fun $FUN(...): (..., signer, ...)
        - pattern: |
            public fun $FUN(...): (..., &signer, ...)
      #
      # Metavariable matching reference is broken on the Semgrep side. For now, we
      # will manually enumerate the patterns (`signer` and `&signer`).
      #
      # - metavariable-pattern:
      #     metavariable: $RETURN
      #     pattern-either:
      #       - pattern: signer
      #       - pattern: "&signer"