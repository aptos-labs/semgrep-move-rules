rules:
  - id: constructor-ref-leak
    languages: [move_on_aptos]
    message: Public functions should not return ConstructorRef https://aptos.dev/en/build/smart-contracts/move-security-guidelines#constructorref-leak.
    severity: INFO
    patterns:
      - pattern-not: |
          #[test_only]
          fun $FUN(...): ...
      - pattern-not: |
          #[test]
          fun $FUN(...): ...
      - pattern-not: |
          #[test(...)]
          fun $FUN(...): ...
      
      # Aptos libraries are exempted
      - pattern-not-inside: |
            module aptos_token_objects::$ANY { ... }
      - pattern-not-inside: |
            module aptos_framework::$ANY { ... }
      
      - pattern: | 
          public fun $FUN(...): $RETURN
      - metavariable-pattern:
          metavariable: $RETURN
          pattern-either:
            - pattern: "&std::object::ConstructorRef"
            - pattern: "&aptos-framework::object::ConstructorRef"
            - pattern: std::object::ConstructorRef
            - pattern: aptos-framework::object::ConstructorRef
            - pattern: 0x1::object::ConstructorRef
            - pattern: "&0x1::object::ConstructorRef"