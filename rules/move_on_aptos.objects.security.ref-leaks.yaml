rules:
  - id: constructor-ref-leak
    languages: [move_on_aptos]
    message: Public functions should not return constructor or signer (references).
    patterns:
      - pattern-not: |
          #[test_only]
          fun $FUN(...): ...
      - pattern-not: |
          #[test]
          fun $FUN(...): ...
      - pattern-not: |
          #[test(...)]
          fun $FUN(...): ...
      
      # Aptos libraries are exempted
      - pattern-not-inside: |
            module aptos_token_objects::$ANY { ... }
      - pattern-not-inside: |
            module aptos_framework::$ANY { ... }

      - pattern-either:
        - pattern: |
            public fun $FUN(...): $RETURN
        - pattern: |
            public(friend) fun $FUN(...): $RETURN
      - metavariable-pattern:
          metavariable: $RETURN
          patterns:
            - pattern-either:
              - pattern: signer
              - pattern: "&signer"

              # No FQN for ConstructorRef because there are multiple types of ConstructorRef
              - pattern: "&ConstructorRef"
              - pattern: ConstructorRef

    severity: WARNING